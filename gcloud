#!/usr/bin/env variant
# vi: ft=yaml

import: .toolbox/tools/cloud/variant-lib/utils.yaml

# bindParamsFromEnv: true
autoenv: true

parameters:
- name: CLOUDSDK_CORE_PROJECT
  type: string

- name: CLOUDSDK_COMPUTE_ZONE
  type: string

- name: CLOUDSDK_CONTAINER_CLUSTER
  type: string

- name: key_file
  type: string

steps:
- task: before
- task: exec
  arguments:
    cmd: |
      gcloud {{ .args | join " " }}
- task: after

tasks:
  before:
    steps:
    - task: chamber
    - task: gpg.import_key
    - task: git-secret.reveal
      arguments:
        secret_file: "{{ .key_file }}"
    - task: activate-service-account

  after:
    steps:
    - task: git-secret.delete
      arguments:
        secret_file: "{{ .key_file }}"

  activate-service-account:
    autoenv: true
    steps:
    - task: exec
      arguments:
        title: "Google Cloud :: Set project & activate service account"
        cmd: |
          gcloud config set project {{ .CLOUDSDK_CORE_PROJECT }}
          gcloud auth activate-service-account --key-file={{ .key_file }}

  get-credentials:
    autoenv: true
    steps:
    - task: exec
      arguments:
        title: "Google Cloud :: Cluster :: Get credentials"
        cmd: |
          gcloud container clusters get-credentials {{ .CLOUDSDK_CONTAINER_CLUSTER }}
