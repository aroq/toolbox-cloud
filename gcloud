#!/usr/bin/env variant
# vi: ft=yaml

import: .toolbox/core/variant-lib/utils.yaml

# bindParamsFromEnv: true
autoenv: true

parameters:
- name: CLOUDSDK_CORE_PROJECT
  type: string

- name: CLOUDSDK_COMPUTE_ZONE
  type: string

- name: CLOUDSDK_CONTAINER_CLUSTER
  type: string

- name: key_file
  type: string

steps:
- task: setup
- task: exec
  arguments:
    cmd: |
      gcloud {{ .args | join " " }}

tasks:
  gpg:
    bindParamsFromEnv: true
    parameters:
    - name: TOOLBOX_GPG_KEY_FILE_PATH
      type: string
    tasks:
      import_key:
        steps:
        - task: exec
          arguments:
            title: GPG :: Import key
            cmd: |
              gpg --batch --import {{ .TOOLBOX_GPG_KEY_FILE_PATH }}

  git-secret:
    parameters:
    - name: secret_file
      type: string
    tasks:
      hide:
        steps:
        - task: exec
          arguments:
            title: Git secret :: Hide secret
            cmd: |
              git secret hide {{ .secret_file }}
      reveal:
        steps:
        - task: exec
          arguments:
            title: Git secret :: Reveal secret
            cmd: |
              git secret reveal -f {{ .secret_file }}
      delete:
        steps:
        - task: exec
          arguments:
            title: Git secret :: Remove secret file
            cmd: |
              rm {{ .secret_file }}

  setup:
    steps:
    - task: gpg.import_key
    - task: git-secret.reveal
      arguments:
        secret_file: "{{ .key_file }}"
    - task: setup.sa
    - task: git-secret.delete
      arguments:
        secret_file: "{{ .key_file }}"
    tasks:
      sa:
        autoenv: true
        steps:
        - task: exec
          arguments:
            title: Google Cloud :: Set project & activate service account
            cmd: |
              gcloud config set project {{ .CLOUDSDK_CORE_PROJECT }}
              gcloud auth activate-service-account --key-file={{ .key_file }}

      get-credentials:
        autoenv: true
        steps:
        - task: exec
          arguments:
            title: Google Cloud :: Cluster :: Get credentials
            cmd: |
              gcloud container clusters get-credentials {{ .CLOUDSDK_CONTAINER_CLUSTER }}

